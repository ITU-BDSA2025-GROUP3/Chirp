@page "/"
@model Chirp.Web.Pages.PublicModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Chirp!";
    Layout = "Shared/_Layout";
}

<div>
    <h2> Public Timeline </h2>
    @if (User.Identity!.IsAuthenticated)
    {
        <div class="cheepbox">
            <h3>What's on your mind @(User.Identity.Name)?</h3>
            <form method="post" asp-page-handler="Cheep">
                <input style="float: left" type="text" asp-for="Message">
                <input type="hidden" name="page" value="@Model.CurrentPage" />
                <button type="submit"
                        style="height: 22px; width: 70px; margin-left: 5px;background-color: #571010;font-weight: bold;border: 1px solid #3b0707;font-size: 14px;font-family: 'Trebuchet MS', sans-serif;border-radius: 2px; padding: 0">
                    Submit
                </button>
                <span asp-validation-for="Message" style="color: red; display: inline-flex"></span>
            </form>
        </div>
    }

    @if (Model.Cheeps.Any())
    {
        <ul id="messagelist" class="cheeps">
            @foreach (var cheep in Model.Cheeps)
            {
                <li style="display: inline-flex;
                    flex-direction: row;
                    justify-content: space-between;
                    align-items: center;
                    width: 98%;">
                    <p>
                        <strong>
                            <a href="/@cheep.UserName">@cheep.UserName</a>
                        </strong>
                        @cheep.Message
                        <small>&mdash; @cheep.TimeStamp</small>
                    </p>

                    @if (User.Identity!.IsAuthenticated && User.Identity.Name != cheep.UserName)
                    {
                        <form method="post" asp-page-handler="ToggleComments" asp-route-cheepId="@cheep.CheepId" style="margin-right: 5px">
                            <input type="hidden" asp-for="CommentTargetId" value="@Model.CommentTargetId"/>
                            <input type="hidden" name="page" value="@Model.CurrentPage" />
                            <button type="submit">@(Model.CommentTargetId == cheep.CheepId ? "Close" : "Comment")</button>
                        </form>
                        
                        if (Model.Followers.Any(f => f.Name == cheep.UserName))
                        {
                            <form method="post" asp-page-handler="Unfollow" asp-route-authorToUnfollow="@cheep.UserName">
                                <input type="hidden" name="page" value="@Model.CurrentPage" />
                                <button type="submit">Unfollow</button>
                            </form>
                        }
                        else
                        {
                            <form method="post" asp-page-handler="Follow" asp-route-authorToFollow="@cheep.UserName">
                                <input type="hidden" name="page" value="@Model.CurrentPage" />
                                <button type="submit">Follow</button>
                            </form>
                        }
                    }
                </li>
                @if (Model.CommentTargetId == cheep.CheepId && User.Identity.Name != cheep.UserName)
                {
                    <div class="cheepbox">
                        <h3>Comment for @cheep.UserName </h3>
                        <form method="post" asp-page-handler="CommentForm" asp-route-cheepId="@cheep.CheepId">
                            <input style="float: left" type="text" asp-for="Comment">
                            <input type="hidden" name="page" value="@Model.CurrentPage" />
                            <button type="submit"
                                    style="height: 22px; width: 70px; margin-left: 5px;background-color: #571010;font-weight: bold;border: 1px solid #3b0707;font-size: 14px;font-family: 'Trebuchet MS', sans-serif;border-radius: 2px; padding: 0">
                                Submit
                            </button>
                            <span asp-validation-for="Message" style="color: red; display: inline-flex"></span>
                        </form>
                        <ul>
                            @foreach (var comment in Model.Comments.Where(c => c.CheepId == cheep.CheepId))
                            {
                                <li style="display: inline-flex;
                                flex-direction: row;
                                justify-content: space-between;
                                align-items: center;
                                width: 98%;">
                                    <p>
                                        <strong>
                                            <a href="/@comment.UserName">@comment.UserName</a>
                                        </strong>
                                        @comment.Comment
                                        <small>&mdash; @comment.TimeStamp</small>
                                    </p>
                                </li>
                            }
                        </ul>
                    </div>
                }
                // TODO display all existing comments here when user clicks
            }
        </ul>
    }
    else
    {
        <em>There are no cheeps so far.</em>
    }

    @if (Model.TotalPages > 1)
    {
        <nav class="pagination">
            @if (Model.CurrentPage > 1)
            {
                <a class="page-link" href="?page=@(Model.CurrentPage - 1)" >
                    Previous
                </a>
            }
            else
            {
                <span class="page-link disabled">Previous</span>
            }
            <span>Page @Model.CurrentPage of @Model.TotalPages</span>
            @if (Model.CurrentPage < Model.TotalPages)
            {
                <a class="page-link" href="?page=@(Model.CurrentPage + 1)">
                    Next
                </a>
            }
            else
            {
                <span class="page-link disabled">Next</span>
            }
        </nav>
    }
</div>